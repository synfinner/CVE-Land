import json
import hashlib
import secrets
import os.path
from flask import request, session, redirect, render_template, flash

def hash_token(username, token):
    hashed_token = hashlib.sha256((salt + username + token).encode('utf-8')).hexdigest()
    return hashed_token

# Load the tokens from the JSON file
with open('tokens.json', 'r') as f:
    tokens = json.load(f)
# Load the salt from the JSON file
with open('salt.json', 'r') as f:
    salt = json.load(f)['salt']

def requires_auth(f):
    def wrapper(*args, **kwargs):
        auth = request.headers.get('Authorization')
        if not auth:
            return 'Missing authorization header', 401
        auth_parts = auth.split(' ')
        if len(auth_parts) != 3 or auth_parts[0] != 'Bearer':
            return 'Invalid authorization header, lol', 401
        username = auth_parts[1]
        token = auth_parts[2]
        hashed_token = hash_token(username, token)
        if username not in tokens or hashed_token != tokens[username]['hashed_token']:
            return 'Invalid token, bro. Try again.', 401
        return f(*args, **kwargs)

    # Set the name of the wrapper function to the name of the decorated function
    wrapper.__name__ = f.__name__
    return wrapper